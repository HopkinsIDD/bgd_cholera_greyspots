---
title: "Bangladesh surveillance greyspots"
author: "Elonia"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE, eval=TRUE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, warning=FALSE, message=FALSE, fig.align="center")
library(kableExtra)

```

```{r captioner, include=FALSE, eval=TRUE}
library(captioner)
tab_nums <- captioner(prefix = "Table ", auto_space = FALSE)
fig_nums <- captioner(prefix = "Figure ", auto_space = FALSE)
```

```{r, settings}
source("source/util.R")
reload_source()

```

## Notes
The goal of this study is to identify how well the Bangladesh national cholera surveillance system captures:
1. the Bangladeshi population
1. the Bangladeshi population living in high, medium, and low risk cholera areas

We define cholera surveillance zones as geographies surrounding one of the 22 cholera sentinel hospitals. Surveillance zones are defined as the area enclosed within a circular buffer with a radius of 10 km, 30 km, or 50 km surrounding the coordinates of a given sentinel hospital.

The values we want to estimate include:
1. percentage of the population living in cholera surveillance zones
1. number and percentage of infections residing in cholera surveillance zones within the last year
1. number and percentage of infections residing in cholera surveillance zones that are in high, medium, and low infection risk areas
1. number and percentage of people living in high, medium, and low infection risk areas that would be captured by cholera surveillance zones

We use the following threshold for defining high, medium, and low risk infection areas:
* RR >= 1.5 is high risk
* 0.5 < RR < 1.5 is medium risk
* RR <= 0.5 is low risk

```{r, import-data, include = FALSE}

## sentinel hospital location data
hosp_dat <- read_csv("data/hosp_GPS.csv")
hosp_loc <- sf::st_as_sf(hosp_dat %>% dplyr::select(LON,LAT), coords = c("LON","LAT"),crs="+proj=longlat +datum=WGS84 +no_defs") ## lat/lon coords on different crs

## WorldPop population raster (log-linear interpolation for 2015 from all WorldPop raster data )
pop_rast <- raster("data/BGD_ppp_2015_adj_v2.tif")
## shapefiles for Bangladesh
adm0_shp <- readRDS("data/BGD_adm0.rds") %>% st_as_sf()
adm2_shp <- readRDS("data/BGD_adm2.rds") %>% st_as_sf()

## import buffer files (multipolygon versions)
mp_filenames <- grep("multipoly", list.files("generated_data/", pattern = "*.shp"), value = TRUE)
buff_mp_ls <- lapply(mp_filenames, function(fn){
  st_read(paste0("generated_data/", fn))
})
mp_names <- sub(".shp", "", sub("buff_sf_multipoly_", "", mp_filenames))
names(buff_mp_ls) <- mp_names

## import buffer files (single polygon versions)
sp_filenames <- grep("singlepoly", list.files("generated_data/", pattern = "*.shp"), value = TRUE)
buff_sp_ls <- lapply(sp_filenames, function(fn){
  st_read(paste0("generated_data/", fn))
})
sp_names <- sub(".shp", "", sub("buff_sf_singlepoly_", "", sp_filenames))
names(buff_sp_ls) <- sp_names

```

There are 22 sentinel hospital sites (`r tab_nums("tab-hospnames", display = "cite")`).

```{r, proc-tab-hospnames}

display_hospnames_tab <- hosp_dat %>% 
  dplyr::select(HOSP, Name, Division, LAT, LON)

tab_nums(name = "tab-hospnames", caption = "**Sentinel hospital IDs and locations.**", display = FALSE)
```

`r tab_nums("tab-hospnames", display = "full")`

```{r, disp-tab-hospnames}
knitr::kable(display_hospnames_tab, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("ID", "Hospital", "Division", "Latitude", "Longitude"))

```

Cholera surveillance zone summaries (`r tab_nums("tab-survzone", display = "cite")`, `r fig_nums("fig-survzone", display = "cite")`).

```{r, proc-tab-survzone}

tot_pop <- sum(values(pop_rast), na.rm = TRUE)

display_survzone_tab <- map_dfr(mp_names, function(mp_nm){
  
  data.frame(buffer = as.numeric(sub("km", "", mp_nm)), pop_buffer = buff_mp_ls[[mp_nm]]$pop) %>%
    dplyr::mutate(prop_buffer = pop_buffer/tot_pop)
})

tab_nums(name = "tab-survzone", caption = "**Cholera surveillance zone summary.**", display = FALSE)
```

`r tab_nums("tab-survzone", display = "full")`

```{r, disp-tab-survzone}
knitr::kable(display_survzone_tab, format = "pandoc", booktabs = T, align = "c", row.names = FALSE)
##, col.names = c("Buffer (km)", "Pop", "Prop of Pop")

```

```{r, fig-survzone}
ggplot(display_survzone_tab, aes(x = buffer, y = prop_buffer)) +
  geom_point() +
  theme_bw() + 
  scale_x_continuous("Buffer (km)", limits = c(0,60)) +
  scale_y_continuous("Proportion", limits = c(0,1))

fig_nums(name = "fig-survzone", caption = "**Proportion of total population captured in cholera surveillance zone, by buffer radius size**", display = FALSE)
```

`r fig_nums("fig-survzone", display = "full")`


In the absence of better data on health care utilization around the hospital sentinel surveillance sites, we assumed that buffers with radii of 10 km, 30 km, and 50 km around the hospital could serve as proxies for potential hospital catchment areas (`r fig_nums("fig-map-buffers", display = "cite")`).


```{r, fig-map-buffers}

buffer_labels <- paste0(c(10, 30, 50), "km")
buffermaps <- lapply(buffer_labels, function(dist){
  map_buffers(adm0_shp, adm2_shp, hosp_loc, buff_mp_ls[[dist]])
}) 

wrap_plots(buffermaps) 
fig_nums(name = "fig-map-buffers", caption = "**Map of 10 km, 30 km, and 50 km buffers around sentinel hospital sites (left, center, right, respectively).**", display = FALSE)

```

`r fig_nums("fig-map-buffers", display = "full")`


```{r, import-serodata}
if(file.exists("data/village_preds_all_bgdintersect.rds")){
  sero <- readRDS("data/village_preds_all_bgdintersect.rds")
} else{
  sero <- readRDS("data/village_preds_all.rds") %>%
    dplyr::mutate(inf = mean2_cor*pop)

  ## transform sero data to match buffer data crs
  sero <- st_transform(sero, crs = crs(buff_mp_ls[[1]]))
  ## intersect sero data with bangladesh map
  sero <- st_intersection(sero, adm0_shp)
  saveRDS(sero,"data/village_preds_all_bgdintersect.rds")
}


## create risk categories
## look at distribution of number of infections and population weighted RR in country and categorize 
summary(sero$inf)
summary(sero$rr2_cor)

## RR > 1.5 is high, 1.5-0.5 is medium, < 0.5 is low 
## Number of infections > 5000 is high, 5000-2000 is medium, < 2000 is low (based on percentiles)

sero_df <- sero %>% 
  dplyr::mutate(rr_risk_cat = ifelse(rr2_cor < 0.5, "Low", ifelse(rr2_cor >= 0.5 & rr2_cor < 1.5, "Moderate", "High")),
                inf_risk_cat = ifelse(inf < 2000, "Low", ifelse(inf >= 2000 & inf < 5000, "Moderate", "High"))) %>% 
  dplyr::mutate(rr_risk_cat = factor(rr_risk_cat, levels = c("High","Moderate","Low")),
                inf_risk_cat = factor(inf_risk_cat, levels = c("High","Moderate","Low")))

```

```{r, process-sero-buffers}

## intersect shapefile of buffers with raster and combine into one dataframe
catch <- lapply(buffer_labels, function(dist){
  st_intersection(sero_df, buff_mp_ls[[dist]]) 
})
names(catch) <- buffer_labels

tab_nums(name = "est-infections-tab", caption = "**Estimate number and percent infections **", display = FALSE)
```

```{r, plt-sero-buffers, fig.dim = c(6.5,4), results = "asis"}

for(i in 1:length(buffer_labels)){
  
  km_label <- buffer_labels[i]
  intersect_sero <- catch[[km_label]]
  
  plt <- ggplot() + 
    geom_sf(data = adm0_shp, fill = NA, lwd = 0.1, alpha = .1) + 
    geom_sf(data = intersect_sero, aes(fill = rr_risk_cat), color = NA, lwd = 0) +
    geom_sf(data = hosp_loc, shape = 3, color = "black", size = 1, lty = 4) +
    scale_colour_manual(values = c("#e41a1c","#377eb8","#4daf4a","#984ea3")) +
    coord_sf(datum = NA) + 
    labs(x="") + labs(y="") + 
    theme_void() + 
    ggsn::north(adm2_shp) +
    scalebar(adm2_shp, dist = 50, dist_unit = "km",transform = TRUE, model = "WGS84", st.size = 2)
  print(plt)
  ggsave(filename = paste0("figures/sero-buffers-", km_label, ".pdf"), plt, width = 6.5, height = 4, units = "in")

  cat(fig_nums(name = paste0("sero-buffers-", km_label, "-plt"), caption = paste("**Relative risk of cholera infection within sentinel hospital buffer zones (**", km_label, "**)**"), display = "full"))
}


```

`r tab_nums("est-infections-tab", display = "full")`

```{r, tab-est-infections}
#total number of infections in BGD
tot_inf <- sum(sero$inf)

#calculate number and percent of infections
# est1 <- catch %>% 
#   group_by(buff) %>%
#   dplyr::summarise(no_inf=sum(inf),pop=sum(pop)) %>%
#   ungroup %>%
#   dplyr::mutate(perc_inf=(no_inf/tot_inf)) %>% 
#   dplyr::mutate(perc_inf=percent(perc_inf),no_inf=comma(no_inf),pop=comma(pop)) %>%
#   dplyr::rename("Buffer size"=buff,"Percent infected"=perc_inf,"Population size"=pop, "Number infected"=no_inf) %>% 
#   data.frame() %>%
#   as_tibble() %>% dplyr::select(-c(.))
# 
# formattable(est1, align =c("l","c","c","c"), list(
#   Buffer.size = formatter("span", style = ~ style(color = "grey",font.weight = "bold")), 
#   Population.size = color_tile("#71CA97", "#DeF7E9"),
#   Number.infected = color_tile("#71CA97", "#DeF7E9"),
#   Percent.infected = color_tile("#71CA97", "#DeF7E9")
# )) %>%
#   kable(escape = F)




```

```{r, est-intersect-serobuffer}



```

## To do
* High risk infection areas by cases and relative risk