---
title: "Bangladesh surveillance greyspots"
subtitle: "April 22, 2021"
author: "Elonia"
description: "Developing a data-driven approach to improve sentinel surveillance design with a case study of cholera in Bangladesh."
output: 
  html_document:
    toc: true
    toc_depth: 3
  
knit: (function(inputFile, encoding) { 
          rmarkdown::render(inputFile,
                        encoding=encoding, 
                output_file='explore_greyspots_20210422.html') })
---

```{r setup, include=FALSE, eval=TRUE}
options(tinytex.verbose = TRUE, scipen = 999)
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, warning=FALSE, message=FALSE, fig.align="center")
library(kableExtra)

```

```{r captioner, include=FALSE, eval=TRUE}
library(captioner)
tab_nums <- captioner(prefix = "Table ", auto_space = FALSE)
fig_nums <- captioner(prefix = "Figure ", auto_space = FALSE)
stab_nums <- captioner(prefix = "Supplementary Table ", auto_space = FALSE)
sfig_nums <- captioner(prefix = "Supplementary Figure ", auto_space = FALSE)
```

```{r, settings}
source("source/util.R")
reload_source()
code_str <- "_20210422"

```

```{r, import-data, include = FALSE}
## Import data on hospitals in Bangladesh that test for V. cholerae

std_crs_txt <- "+proj=tmerc +lat_0=0 +lon_0=90 +k=0.9996 +x_0=500000 +y_0=0 +a=6377276.345 +b=6356075.41314024 +towgs84=283.7,735.9,261.1,0,0,0,0 +units=km +no_defs" ## BGD UTM projection
gadm_crs_txt <- "+proj=longlat +datum=WGS84 +no_defs"

## sentinel hospital location data
hosp_dat <- read_csv("data/hosp_GPS_wicddrb.csv")
hosp_dat_gadmcrs <- sf::st_as_sf(hosp_dat, coords = c("LON","LAT"), crs = gadm_crs_txt) ## lat/lon coords on different crs

## transform hospital coords to match standard bgd crs in km
hosp_dat <- st_transform(hosp_dat_gadmcrs, std_crs_txt)

## shapefiles for Bangladesh
adm0_shp_gadmcrs <- readRDS("data/BGD_adm0.rds") %>% st_as_sf()
adm2_shp_gadmcrs <- readRDS("data/BGD_adm2.rds") %>% st_as_sf()
adm0_shp <- st_transform(adm0_shp_gadmcrs, std_crs_txt)
adm2_shp <- st_transform(adm2_shp_gadmcrs, std_crs_txt)

out_wd <- "generated_data/mixed_wicddrb/"
fig_wd <- "figures/"
```

```{r, import-sero, include = FALSE}

## Import seroincidence estimates in Bangladesh based on a nationally-representative 2015 serosurvey
## New filename is entropy-map.rds and old is grid-cell-data-w-entropy.rds
## Notes:
  ## this file has duplicate grid cells here for mapping purposes. 
  ## one set of cols (toPlt) is the original file and ideal for plotting at grid cell level
  ## one set of cols (toAgg) is best used for summing across number of infections
  ## data from Steve from June 2020 (revisions to Lancet ID)

  sero_import <- readRDS("data/entropy-map.rds") %>% 
    dplyr::select(grid_id, pop, rr_median, rr_lb, rr_ub, inc_mean, inc_median, inc_lb, inc_ub, rr_med_bound, rr_lb_bound, rr_ub_bound, rr_int_log_diff, inc_interval_width, implied_inf, entropy2) %>%
    dplyr::mutate(prop_inf_toPlt = ifelse(pop>0, implied_inf/pop, 0)) %>%
    dplyr::mutate(pop_toAgg = pop,
                  implied_inf_toAgg = implied_inf,
                  prop_inf_toAgg = prop_inf_toPlt) %>%
    dplyr::rename(pop_toPlt = pop,
                  implied_inf_toPlt = implied_inf) 
  dup_ix <- which(duplicated(sero_import$grid_id))
  sero_import[dup_ix,]$pop_toAgg <- NA
  sero_import[dup_ix,]$implied_inf_toAgg <- NA
  sero_import[dup_ix,]$prop_inf_toAgg <- NA

  ## transform sero data to match standard bgd crs in km
  sero <- st_transform(sero_import, crs = std_crs_txt)
  
  
  
## Load RDS of INLA estimates of seroincidence per grid-cell (for 1,000 random posterior draws from Stan model estimating seroincidence by sampled community)
  ## rep = unique random draw identifier (n=1000)
  ## grid_id = corresponds to grid id in entropy_map.rds (n=6163) - entropy_map.rds has n=6159
  ## sample_rr = risk relative to mean risk across country for a random map (from INLA model)
  ## note: the summary stats (mean, median, rr, lb, ub) reported in file are generated by INLA and not used for results as they underestimate the overall variance
  ## note: used sampled estimates instead (sample_rr) because drew one random map for whole country and provides estimates for each cell in that random map. (sample_total=sample_rate*cell_population)

  ## checking overlapping grid cells 
  # which(!boots$grid_id[1:6163] %in% sero_import$grid_id) #94, 1097, 5504, 6118 don't overlap so can get rid of this grid_ids in boots file (likely islands/edge grid cells)
  
  ## checking duplicate ids in sero data file - 1721 duplicated grid_ids
  # y <- sero %>% dplyr::filter(duplicated(grid_id)) %>% dplyr::arrange(grid_id)
  # c <- sero %>% arrange(grid_id)
  # y.dup <- sero %>% arrange(grid_id) %>% dplyr::filter(!duplicated(grid_id)) 
  # all duplicated grid_ids appear to have same values except NA values for pop_toAgg and implied_inf_toAgg so will get rid of duplicated grid_ids from sero file used to merge to boots file
  
boots <- readRDS("data/all-boots.rds") %>%
  as_tibble() %>%
  dplyr::select(grid_id,sample_rate,sample_total,sample_rr,rep) %>%
  dplyr::filter(grid_id!=94&grid_id!=1097&grid_id!=5504&grid_id!=6118) %>%
  left_join(sero %>% 
              dplyr::select(grid_id,pop_toAgg,pop_toPlt) %>%
              dplyr::filter(!duplicated(grid_id)), by = c("grid_id")) %>%
  dplyr::mutate(implied_inf = sample_total) 


## loading location of serosurvey sites 
sero.sites <- readRDS("data/dat_with_raster_covs_sero.rds") %>% 
  group_by(CommLong,CommLat,villid,adm2name) %>% 
  dplyr::summarize(prop_pos = mean(pred_365)) %>% 
  ungroup %>%
  dplyr::rename(LONG=CommLong,LAT=CommLat) 
sero.sites <- sf::st_as_sf(sero.sites %>% dplyr::select(LONG,LAT,prop_pos),
                           coords = c("LONG","LAT"),crs="+proj=longlat +datum=WGS84 +no_defs") 


```


```{r, generate-buffers, include = FALSE}

## Identifying the cholera surveillance zone
## SET THIS: radii in km for subdistrict, district, tertiary, and icddr,b (special) hospitals, respectively

km_vec_ls <- list(B1 = c(10, 20, 30, 30)#, 
                  #B2 = c(10, 10, 30, 30)
                  ) 

for(i in 1:length(km_vec_ls)){

  km_vec <- km_vec_ls[[i]]

  hosp_dat2 <- hosp_dat %>%  
    dplyr::mutate(buff_radius = ifelse(Type == "subdistrict", km_vec[1], ifelse(Type == "district", km_vec[2], ifelse(Type == "tertiary", km_vec[3], ifelse(Type == "icddrb", km_vec[4], NA)))))

  buff_sp <- st_buffer(hosp_dat2, dist=hosp_dat2$buff_radius, nQuadSegs = 30, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 1) %>%
    dplyr::mutate(hosp_id = hosp_dat2$HOSP,
                  hosp_name = hosp_dat2$Name,
                  hosp_division = hosp_dat2$Division,
                  hosp_type = hosp_dat2$Type)
  
  ## single polygon per hospital
  ## note that this sf dataframe includes duplicate grid cells if a grid cell appeared in the buffer zone of more than one hospital
  ## this dataframe also includes columns that indicate the hospital associated to a given buffer zone
  sero_buff_sp <- sf::st_intersection(sero, buff_sp)
  saveRDS(sero_buff_sp, paste0(out_wd, "sero_buff_sf_singlepoly", code_str, "_", paste(km_vec, collapse = "-"), "km.rds"))

  ## multipolygon for all hospitals
  ## combine buffer polygons per hospital into single multipolygon
  buff_mp <- st_sf(st_union(buff_sp))
  sero_buffer_mp <- sf::st_intersection(sero, buff_mp)
  saveRDS(sero_buffer_mp, paste0(out_wd, "sero_buff_sf_multipoly", code_str, "_", paste(km_vec, collapse = "-"), "km.rds"))

  ## save plot
  buff_map <- map_buffers(adm0_shp, adm2_shp, hosp_dat2, buff_mp)
  ggsave(paste0(fig_wd, "buff_", paste(km_vec, collapse = "-"), "km.pdf"), buff_map, width = 4, height = 4)
}

```

```{r, import-buffers, include = FALSE}

## these files should all be in stdcrs
## import buffer files (multipolygon versions)
mp_filenames <- grep(paste0("multipoly", code_str), list.files(out_wd, pattern = "*.rds"), value = TRUE)
sero_buff_mp_ls <- lapply(mp_filenames, function(fn){
  readRDS(paste0(out_wd, fn))
})
mp_names <- sub(".rds", "", sub(paste0("sero_buff_sf_multipoly", code_str, "_"), "", mp_filenames))
names(sero_buff_mp_ls) <- mp_names

## import buffer files (single polygon versions)
sp_filenames <- grep(paste0("singlepoly", code_str), list.files(out_wd, pattern = "*.rds"), value = TRUE)
sero_buff_sp_ls <- lapply(sp_filenames, function(fn){
  readRDS(paste0(out_wd, fn))
})
sp_names <- sub(".rds", "", sub(paste0("sero_buff_sf_singlepoly", code_str, "_"), "", sp_filenames))
names(sero_buff_sp_ls) <- sp_names

```

```{r, set-buffer-sizes}
## Set buffers here for subsequent analyses
buffer_labels <- mp_names

```


```{r, rr-thresholds-sandbox, include=F}

## Defining measures of risk of infection with _V. cholerae_
## Although we have great uncertainty about the relative seroincidence risk across Bangladesh, our previous modeling efforts represent the best information we have about cholera risk in a given location. We used these modeling outputs to characterize the disease risk of populations living in _V. cholerae_ greyspots.
## Using the modeled seroincidence risk of infection with _V. cholerae_, we calculate two quantitative measures at the 5 km x 5 km grid cell level to represent risk of infection: relative risk and absolute number of infections. For each of these measures, we identified thresholds by which we could partition grid cells into "high," "moderate," and "low" risk.

## 1. _Relative risk_: Median seroincidence risk at the grid cell level relative to the population-weighted mean seroincidence risk across Bangladesh. Relative risk of 1 indicates that the grid cell seroincidence risk is the same as the mean risk across the country. We examined the distribution of relative risk and the width of the relative risk confidence interval estimates to determine the range for identifying appropriate cutoffs. 
## We found that the confidence interval estimates were too large to be useful for this purpose. There was very high uncertainty in the relative seroincidence risk. Instead, we arbitrarily chose the relative risks of 0.8 and 1.2 as cutoffs for moderate and high risks.

print("***** What is the distribution of relative risk estimates? *****")
rr_sandbox <- sero %>% dplyr::mutate(rr_range = rr_ub-rr_lb)
hist(rr_sandbox$rr_median, breaks = 50, main = "", xlab = "relative risk")
print("summary stats on median relative risk: deciles")
quantile(rr_sandbox$rr_median, probs = seq(0,1,.1), na.rm = TRUE)
quantile(rr_sandbox$rr_median, na.rm = TRUE)

print("What is the range of the relative risk estimates, where range is the width of the 95% CI?")
hist(rr_sandbox$rr_range/2, breaks = 50, main = "", xlab = "1/2 Range of relative risk estimates")
print("summary stats on 1/2 range of RR: deciles")
quantile(rr_sandbox$rr_range/2, probs = seq(0,1,.1), na.rm = TRUE) 
print("Decision: Confidence interval ranges are too large to be useful. Using 25th and 75th percentiles as cutoffs.")

```


```{r, inf-thresholds-sandbox, include=F}

##2. _Absolute infections_: Median estimated number of the grid cell population infected with _V. cholerae_ in the last year. We examined the distribution of the median number of absolute infections on the log10 scale and chose the 30th and 70th percentiles as cutoffs for moderate and high risk.

print("***** What is the distribution of median infections within the last year? *****")
inf_sandbox <- sero 
hist(log10(inf_sandbox$implied_inf_toAgg), breaks = 50, main="", xlab = "median infections by grid cell (log10 scale)")
print("summary stats on median infections: deciles")
quantile(inf_sandbox$implied_inf_toAgg, probs = seq(0,1,.1), na.rm = TRUE) 
quantile(inf_sandbox$implied_inf_toAgg, na.rm = TRUE)
print("Decision: Using 25th and 75th percentiles (quartiles) as cutoffs")

```


```{r, set-thresholds, include = FALSE}

## Defining measures of risk of infection with _V. cholerae_: relative risk and absolute number of infections (we also define the proportion of cholera infections in each grid cell as was used in previous iterations)
## Using 25% and 75% quartiles 

prop_thresh <- round(quantile(sero$prop_inf_toAgg, probs = c(0.25, 0.75), na.rm = TRUE), 3)
inf_thresh <- round(quantile(sero$implied_inf_toAgg, probs = c(0.25, 0.75), na.rm = TRUE), 3)
rr_thresh <- round(quantile(sero$rr_median, probs = c(0.25, 0.75), na.rm = TRUE), 3)

##1.25 and 1.5 are 30% and 70% RR values in distribution of possible values across Bangladesh
##Using 25th and 75th percentiles aka quartiles to maintain consistency across choices and statistically sound choice

sero2 <- sero %>% 
  dplyr::mutate(rr_risk_cat = ifelse(rr_median < rr_thresh[1], "Low", ifelse(rr_median >= rr_thresh[1] & rr_median < rr_thresh[2], "Moderate", "High")),
                prop_risk_cat = ifelse(prop_inf_toAgg < prop_thresh[1], "Low", ifelse(prop_inf_toAgg >= prop_thresh[1] & prop_inf_toAgg < prop_thresh[2], "Moderate", "High")),
                inf_risk_cat = ifelse(implied_inf_toAgg < inf_thresh[1], "Low", ifelse(implied_inf_toAgg >= inf_thresh[1] & implied_inf_toAgg < inf_thresh[2], "Moderate", "High")),
                prop_risk_cat_toPlt = ifelse(prop_inf_toPlt < prop_thresh[1], "Low", ifelse(prop_inf_toPlt >= prop_thresh[1] & prop_inf_toPlt < prop_thresh[2], "Moderate", "High")),
                inf_risk_cat_toPlt = ifelse(implied_inf_toPlt < inf_thresh[1], "Low", ifelse(implied_inf_toPlt >= inf_thresh[1] & implied_inf_toPlt < inf_thresh[2], "Moderate", "High"))) %>% 
  dplyr::mutate(rr_risk_cat = factor(rr_risk_cat, levels = c("High","Moderate","Low")),
                prop_risk_cat = factor(prop_risk_cat, levels = c("High","Moderate","Low")),
                inf_risk_cat = factor(inf_risk_cat, levels = c("High","Moderate","Low")),
                prop_risk_cat_toPlt = factor(prop_risk_cat_toPlt, levels = c("High","Moderate","Low")),
                inf_risk_cat_toPlt = factor(inf_risk_cat_toPlt, levels = c("High","Moderate","Low"))) 


saveRDS(sero2, paste0("data/clean_sero_bgdintersect", code_str, ".rds"))

```


```{r, proc-tab-hospnames}

## Supplementary Table 1. List of 23 cholera surveillance hospitals.

display_hospnames_tab <- hosp_dat2 %>% 
  as.data.frame %>%
  dplyr::select(HOSP, Name, Division, Type)

stab_nums(name = "tab-hospnames", caption = "The sentinel hospital IDs and locations. There are 23 hospital sites that perform laboratory confirmation of _V. cholerae_ in Bangladesh.", display = FALSE)

```

`r stab_nums("tab-hospnames", display = "full")`

```{r, disp-tab-hospnames}

knitr::kable(display_hospnames_tab, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("ID", "Hospital", "Division", "Type"))

```


```{r, generate-buffers2, include = FALSE}

## Overlap of bangladesh seroincidence map and cholera surveillance zone
## Regenerating the buffers again so that the buffer objects include the sf dataframe with seroincidence thresholds

for(i in 1:length(km_vec_ls)){

  km_vec <- km_vec_ls[[i]]

  hosp_dat2 <- hosp_dat %>%  
    dplyr::mutate(buff_radius = ifelse(Type == "subdistrict", km_vec[1], ifelse(Type == "district", km_vec[2], ifelse(Type == "tertiary", km_vec[3], ifelse(Type == "icddrb", km_vec[4], NA)))))

  buff_sp <- st_buffer(hosp_dat2, dist=hosp_dat2$buff_radius, nQuadSegs = 30, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 1) %>%
    dplyr::mutate(hosp_id = hosp_dat2$HOSP,
                  hosp_name = hosp_dat2$Name,
                  hosp_division = hosp_dat2$Division,
                  hosp_type = hosp_dat2$Type)
  
  ## single polygon per hospital
  ## note that this sf dataframe includes duplicate grid cells if a grid cell appeared in the buffer zone of more than one hospital
  ## this dataframe also includes columns that indicate the hospital associated to a given buffer zone
  sero_buff_sp <- sf::st_intersection(sero2, buff_sp) 
  saveRDS(sero_buff_sp, paste0(out_wd, "sero_buff_sf_singlepoly", code_str, "_", paste(km_vec, collapse = "-"), "km.rds"))


  ## multipolygon for all hospitals
  ## combine buffer polygons per hospital into single multipolygon
  buff_mp <- st_sf(st_union(buff_sp))
  sero_buffer_mp <- sf::st_intersection(sero2, buff_mp) 
  saveRDS(sero_buffer_mp, paste0(out_wd, "sero_buff_sf_multipoly", code_str, "_", paste(km_vec, collapse = "-"), "km.rds"))

  ## save plot
  buff_map <- map_buffers(adm0_shp, adm2_shp, hosp_dat2, buff_mp)
  ggsave(paste0(fig_wd, "buff_", paste(km_vec, collapse = "-"), "km.pdf"), buff_map, width = 4, height = 4)
}

```



```{r, import-buffers2, include = FALSE}

## Importing the buffers again so that the buffer objects include the sf dataframe with seroincidence thresholds


## overlapping bangladesh seroincidence map + cholera surveillance zone
## these files should all be in stdcrs
## import buffer files (multipolygon versions)
mp_filenames <- grep(paste0("multipoly", code_str), list.files(out_wd, pattern = "*.rds"), value = TRUE)
sero_buff_mp_ls <- lapply(mp_filenames, function(fn){
  readRDS(paste0(out_wd, fn))
})
mp_names <- sub(".rds", "", sub(paste0("sero_buff_sf_multipoly", code_str, "_"), "", mp_filenames))
names(sero_buff_mp_ls) <- mp_names

## import buffer files (single polygon versions)
sp_filenames <- grep(paste0("singlepoly", code_str), list.files(out_wd, pattern = "*.rds"), value = TRUE)
sero_buff_sp_ls <- lapply(sp_filenames, function(fn){
  readRDS(paste0(out_wd, fn))
})
sp_names <- sub(".rds", "", sub(paste0("sero_buff_sf_singlepoly", code_str, "_"), "", sp_filenames))
names(sero_buff_sp_ls) <- sp_names

```


```{r, primary-settings}

## Definitions to help results processing 

## primary cholera surveillance zone settings 
km_label <- "10-20-30-30km"
intersect_sero <- sero_buff_mp_ls[[km_label]]
## all settings df
sero_buff_df <- sf::st_as_sf(data.table::rbindlist(sero_buff_mp_ls, idcol = "buff")) %>%
  sf::st_drop_geometry() %>%
  tibble::as_tibble() %>%
  rowwise %>%
  dplyr::mutate(buff = gsub("km", "", buff)) %>%
  ungroup
## other important quantities
tot_inf <- sum(sero2$implied_inf_toAgg, na.rm = TRUE)
tot_pop <- sum(sero2$pop_toAgg, na.rm = TRUE)
## plot settings
category_cols <- c("#e41a1c","#377eb8","#4daf4a","#984ea3")
category_cols_rev <- c("#4daf4a","#377eb8","#e41a1c")
category_cols_6 <- c("#e41a1c","#e07576","#377eb8","#95bdde","#4daf4a","#b1dbaf")
palette1 <- colorspace::sequential_hcl(3, palette = "RedBlue")
palette2 <- colorspace::qualitative_hcl(3, palette = "Cold")
palette3 <- colorspace::qualitative_hcl(3, palette = "Dark 3")


```


```{r, proc-tab-survzone}

## Supplementary Table 2. Population in the cholera surveillance zone 
## We overlaid the cholera surveillance zone over population data in Bangladesh (original source: 2015 100m WorldPop estimates) to estimate the number of people living within the cholera surveillance zone 

display_survzone_tab <- map_dfr(mp_names, function(mp_nm){
  
  data.frame(buffer = as.character(sub("km", "", mp_nm)), 
            pop_buffer = sum(sero_buff_mp_ls[[mp_nm]]$pop_toAgg, na.rm = TRUE)) %>%
    dplyr::mutate(prop_buffer = pop_buffer/tot_pop)
})

stab_nums(name = "tab-survzone", caption = "Population living in the cholera surveillance zone.", display = FALSE)
```

`r stab_nums("tab-survzone", display = "full")`

```{r, disp-tab-survzone}

knitr::kable(display_survzone_tab, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Buffer (Subdistrict-District-Tertiary-icddr,b in km)", "Pop", "Proportion"))

```



```{r, sfig-sero-rr-map, fig.dim = c(12,12)}

# Supplementary Figure 1. A. Map of relative seroincidence risk
# Using data from a nationally-representative survey across Bangladesh, we developed maps of infection across 5 km x 5km grid cells in Bangladesh. This map estimates that from the 2015 serosurvey data collection there were `r tot_inf` infections in Bangladesh over the past year out of an estimated population of `r tot_pop`. We standardized the seroincidence estimates in each cell by the population-weighted mean of the Bangladesh infection risk in that cell. This yielded a relative risk of infection for each grid cell 

sfig1A <- ggplot() + 
  geom_sf(data = adm0_shp, fill=NA, lwd=0.1, alpha=.1) + 
  geom_sf(data = sero2, aes(fill=rr_med_bound), color=NA, lwd=0) +
  geom_sf(data = hosp_dat2, shape=3, aes(color="black"), size=1.25, lty=1) +
  #scale_colour_manual(values = c("#e41a1c","#377eb8","#4daf4a","#984ea3")) +
  # scale_fill_gradient2(low ="#4191e1", mid = "white", high = "#b20000", midpoint=1.0) +
  # scale_fill_distiller(palette="Spectral", limits=c(-3, 2.5), breaks=seq(-2, 2, 1), labels=c(expression("">= 0.25), "0.5", "1", "2", expression("">=4))) +
  scale_fill_distiller("Relative Risk", palette="Spectral", limits=c(-2, 2), breaks=seq(-2, 2, 1), labels=c("0.25", "0.5", "1", "2", "4")) +
  coord_sf(datum=NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel\nsites",values=c('black'),labels=c('Hospital')) +
  theme_void() #+ 
  # ggsn::north(adm2_shp) +
  # scalebar(adm2_shp, dist = 50, dist_unit = "km",transform = TRUE, model = "WGS84", st.size = 3)

ggsave(filename = paste0(fig_wd, "sero-rr", code_str, ".pdf"), sfig1A, width = 6, height = 6, units = "in")


## Supplementary Figure 1. B. Map of median estimated number of absolute V. cholerae infections in Bangladesh 

sfig1B <- ggplot() + 
  geom_sf(data = adm0_shp, fill=NA, lwd=0.1, alpha=.1) + 
  geom_sf(data = sero2, aes(fill=implied_inf_toPlt), color=NA, lwd=0) +
  geom_sf(data = hosp_dat2, shape=3, aes(color="black"), size=1.25, lty=1) +
  scale_fill_distiller(palette="Spectral", trans="log", labels=c("min","50", "1,000", "22,000","max")) +
  # breaks=seq(0.3,0.6,0.9) 
  coord_sf(datum=NA) + 
  labs(x="") + labs(y="") + labs(fill = "Number of\ninfections") +
  scale_colour_manual(name="Sentinel\nsites",values=c('black'),labels=c('Hospital')) +
  theme_void() 

ggsave(filename = paste0(fig_wd, "sero-inf", code_str, ".pdf"), sfig1B, width = 6, height = 6, units = "in")



plt<- ggpubr::ggarrange(sfig1A,sfig1B,ncol=2,labels = c("A","B"))
print(plt)
ggsave(filename = paste0(fig_wd, "supp-figure-1", code_str, ".pdf"), plt, width = 6, height = 6, units = "in")

```


```{r, sfig-supp-one-cap}

sfig_nums(name = "sfig-supp-one-cap", caption = paste("A. **Median risk of _V. cholerae_ seroincidence relative to a population-weighted mean by 5 km x 5 km grid cell.** These relative risk estimates are bounded such that RRs above and below 2 and -2 were plotted as the values 2 and -2, respectively. The black marks indicate sentinel hospital locations. B. **Median number of estimated V. cholerae infections per grid cell in the previous year. The black marks indicate sentinel hospital locations.** These estimates were calculated as the product of the median seroincidence risk and 2015 WorldPop population estimate in each grid cell. The black marks indicate sentinel hospital locations."), display = FALSE)

```

`r sfig_nums("sfig-supp-one-cap", display = "full")`



```{r, fig-greyspots-map, fig.dim = c(12,12)}

## Figure 1. Cholera surveillance zone greyspots 
#buffermaps <- lapply(buffer_labels, function(dist){
#  map_buffers(adm0_shp, adm2_shp, hosp_dat2, sero_buff_mp_ls[[dist]])
#}) 

fig1 <- ggplot() + 
  geom_sf(data = adm2_shp, fill="#808c84", lwd=0.1) + 
  geom_sf(data = intersect_sero, aes(fill = "#c0c2ff"), lwd=0, alpha=.6) +
  geom_sf(data = hosp_dat2, shape = 3, aes(color = "black"), size = 1.25, lty = 1) + 
  coord_sf(datum=NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel sites",values=c('black'),labels=c('Hospital')) +
  scale_fill_discrete(name="",labels=c('Cholera\nsurveillance zone')) +
  theme_void() 


print(fig1)
ggsave(filename = paste0(fig_wd, "figure-1", code_str, ".pdf"), fig1, width = 6, height = 6, units = "in")

```


```{r, fig-greyspots-map-cap}

fig_nums(name = "fig-greyspots-map-cap", caption = paste("**Cholera greyspots.** The 5 km x 5 km grid cells that are colored are cells covered in the cholera surveillance zone. The greyed out grid cells are areas not captured by the national cholera surveillance system in Bangladesh, where we have little information on clinical cases of cholera."), display = FALSE)
```

`r fig_nums("fig-greyspots-map-cap", display = "full")`



```{r, fig-sero-cat-map, fig.dim = c(12,12)}

# Figure 2. A. Map of categorized relative seroincidence risk by H-C-M and cholera surveillance zones.
## We redrew the relative seroincidence risk map after binning grid cells into high, Moderate, and Low risk categories

fig2A <- ggplot() + 
  geom_sf(data = adm0_shp, fill = NA, lwd = 0.1, alpha = 0.1) + 
  geom_sf(data = sero2, aes(fill = rr_risk_cat), color = NA, lwd = 0.1, alpha=0.6) +
  scale_fill_manual("Risk category", values = category_cols) +
  geom_sf(data = intersect_sero, aes(fill = rr_risk_cat), lwd = 0.05) +
  geom_sf(data = hosp_dat2, shape = 3, aes(color = "black"), size = 1.25, lty = 1) +
  # scale_fill_gradient2(low ="#4191e1", mid = "white", high = "#b20000", midpoint=1.0) +
  coord_sf(datum = NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel sites",values=c('black'),labels=c('Hospital')) +
  theme_void() #+ 
  # ggsn::north(adm2_shp) +
  # scalebar(adm2_shp, dist = 50, dist_unit = "km", transform = FALSE, st.size = 3)

ggsave(filename = paste0(fig_wd, "sero-rrcat", code_str, ".pdf"), fig2A, width = 6, height = 6, units = "in")

## Figure 2. B. Map of categorized absolute number of infections by H-C-M and cholera surveillance zones. We redrew the estimated number of infections risk map after binning grid cells into high, Moderate, and Low risk categories 

fig2B <- ggplot() + 
  geom_sf(data = adm0_shp, fill = NA, lwd = 0.1, alpha = .1) + 
  geom_sf(data = sero2, aes(fill = inf_risk_cat_toPlt), color = NA, lwd = 0.1, alpha=0.6) +
  scale_fill_manual("Risk category", values = category_cols) +
  geom_sf(data = intersect_sero, aes(fill = inf_risk_cat_toPlt), lwd = 0.05) +
  geom_sf(data = hosp_dat2, shape = 3, aes(color = "black"), size = 1.25, lty = 1) +
  coord_sf(datum = NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel sites",values=c('black'),labels=c('Hospital')) +
  theme_void() 

ggsave(filename = paste0(fig_wd, "sero-infcat", code_str, ".pdf"), fig2B, width = 6, height = 6, units = "in")

plt<- ggpubr::ggarrange(fig2A,fig2B,nrow=1,ncol=2,labels = c("A", "B"))
print(plt)
ggsave(filename = paste0(fig_wd, "figure-2", code_str, ".pdf"), plt, width = 6, height = 6, units = "in")

```


```{r, fig-sero-cat-map-cap}

fig_nums(name = "fig-sero-cat-map-cap", caption = "A. **Cholera risk map as categorized by the risk of seroincidence relative to a population-weighted mean by 5 km x 5 km grid cell.** The map illustrates grid cells of High-Considerate-Low risk and the which grid cells are captured by the cholera surveillance zone (10-20-30-30km for subdistrict, district, and tertiary care, and icddr,b hospitals), indicated by the transparent buffers. B. **Cholera risk map as categorized by the estimated number of _V. cholerae_ infections by 5 km x 5 km grid cell.** The black marks indicate sentinel hospital locations and the transparent buffers overlayed represent the cholera surveillance zone.", display = FALSE)

```

`r fig_nums("fig-sero-cat-map-cap", display = "full")`



```{r, fig-bar-plot, fig.dim = c(12,12)}

## Figure 3. The overall percentage of the population living in high-moderate-low risk areas as defined by relative seroincidence risk and absolute number of infections risk measures. B. Bar plot of the percentage of the population in the cholera surveillance zone and percentage of _V. cholerae_ infections in the cholera surveillance zone across Bangladesh and in high-moderate-low risk areas  using the relative seroincidence risk and absolute number of infections as measures of risk. 


## Percent of infections and percent of population in BGD in each risk category for each risk measure (absolute infections and relative risk)
display_inf_riskpops <- sero2 %>%
  group_by(inf_risk_cat_toPlt) %>%
  dplyr::summarise(pop1 = sum(pop_toAgg, na.rm = TRUE), inf1 = sum(implied_inf_toAgg, na.rm = TRUE)) %>% 
  data.frame %>%
  dplyr::select(inf_risk_cat_toPlt, pop1, inf1) 
display_rr_riskpops <- sero2 %>%
  group_by(rr_risk_cat) %>%
  dplyr::summarise(pop1 = sum(pop_toAgg, na.rm = TRUE), inf1 = sum(implied_inf_toAgg, na.rm = TRUE)) %>% 
  data.frame %>%
  dplyr::select(rr_risk_cat, pop1, inf1)
partA_inf <- display_inf_riskpops %>%
  dplyr::rename(risk_cat=inf_risk_cat_toPlt) %>%
  dplyr::mutate(risk_measure="Absolute infections")
partA <- display_rr_riskpops %>%
  dplyr::rename(risk_cat=rr_risk_cat) %>%
  dplyr::mutate(risk_measure="Relative risk") %>%
  bind_rows(., partA_inf) %>%
  dplyr::mutate(perc_pop=(pop1/tot_pop)*100,perc_inf=(inf1/tot_inf)*100,denominator="Bangladesh") %>%
  as_tibble()


## Percent of infections and percent of population in cholera surveillance zone in each risk category for each risk measure (absolute infections and relative risk)
## what is denominator here?? percent of all high risk infections and population in zone among all infections and population in the zone 

tot_inf_rrcat <- sero_buff_df %>% 
  group_by(buff) %>%
  dplyr::summarise(tot_infcat=sum(implied_inf_toAgg, na.rm = TRUE), tot_popcat=sum(pop_toAgg, na.rm = TRUE)) 
display_rrcat_in_buffers <- sero_buff_df %>% 
  group_by(buff, rr_risk_cat) %>%
  dplyr::summarise(num_inf = round(sum(implied_inf_toAgg, na.rm = TRUE)), num_pop = round(sum(pop_toAgg, na.rm = TRUE))) %>%
  left_join(tot_inf_rrcat, by = c("buff")) %>%
  dplyr::mutate(perc_inf = round(num_inf/tot_infcat*100, 1),
                perc_pop = round(num_pop/tot_popcat*100, 1)) %>% 
  dplyr::select(buff, rr_risk_cat, num_inf, perc_inf, num_pop, perc_pop,tot_infcat,tot_popcat) #%>%
  #dplyr::mutate(num_pop=comma_format(digits = 12)(num_pop),num_inf=comma_format(digits = 12)(num_inf))
partB_rr_zone <- display_rrcat_in_buffers %>%
  ungroup %>%
  dplyr::select(rr_risk_cat, num_pop, num_inf, perc_pop, perc_inf) %>%
  dplyr::rename(risk_cat=rr_risk_cat, pop1=num_pop, inf1=num_inf) %>%
  dplyr::mutate(risk_measure="Relative risk", denominator="Surveillance zone") #%>%
  #add_row(risk_cat = "Total", value = display_survzone_tab$prop_buffer*100, fig_type = "Percent of population in the zone", risk_measure="Relative risk")

tot_inf_infcat <- sero_buff_df %>% 
  group_by(buff) %>%
  dplyr::summarise(tot_infcat=sum(implied_inf_toAgg, na.rm = TRUE), tot_popcat=sum(pop_toAgg, na.rm = TRUE)) 
display_infcat_in_buffers <- sero_buff_df %>% 
  group_by(buff, inf_risk_cat_toPlt) %>% 
  dplyr::summarise(num_inf = round(sum(implied_inf_toAgg, na.rm = TRUE)), num_pop = round(sum(pop_toAgg, na.rm = TRUE))) %>%
  left_join(tot_inf_infcat, by = c("buff")) %>%
  dplyr::mutate(perc_inf = round(num_inf/tot_infcat*100, 1),
                perc_pop = round(num_pop/tot_popcat*100, 1)) %>% 
  dplyr::select(buff, inf_risk_cat_toPlt, num_inf, perc_inf, num_pop, perc_pop, tot_infcat, tot_popcat) #%>%
  #dplyr::mutate(num_pop=comma_format(digits = 12)(num_pop),num_inf=comma_format(digits = 12)(num_inf))
partB_inf_zone <- display_infcat_in_buffers %>%
  ungroup %>%
  dplyr::select(inf_risk_cat_toPlt, num_pop, num_inf, perc_pop, perc_inf) %>%
  dplyr::rename(risk_cat=inf_risk_cat_toPlt, pop1=num_pop, inf1=num_inf) %>%
  dplyr::mutate(risk_measure="Absolute infections", denominator="Surveillance zone") #%>%
  #add_row(risk_cat = "Total", value = display_survzone_tab$prop_buffer*100, fig_type = "Percent of population in the zone", risk_measure="Absolute infections")


## Plot

barplot <- partA %>% 
  bind_rows(., partB_rr_zone, partB_inf_zone)
p <- barplot %>%
  dplyr::select(-inf1,-perc_inf) %>%
  dplyr::rename(number=pop1, percent=perc_pop) %>%
  dplyr::mutate(output="population") %>% 
  mutate(risk_cat = factor(risk_cat, levels = c("High", "Moderate", "Low")))
i <- barplot %>%
  dplyr::select(-pop1,-perc_pop) %>%
  dplyr::rename(number=inf1, percent=perc_inf) %>%
  dplyr::mutate(output="infections") %>%
  bind_rows(.,p) %>% 
  mutate(risk_cat = factor(risk_cat, levels = c("High", "Moderate", "Low")))


fig3_num <- ggplot(data=i,aes(x=risk_cat,fill=risk_cat,alpha=denominator)) + 
  geom_bar(data=i %>% filter(output=="population"),aes(y=number),
           position="dodge",stat="identity") + 
  geom_bar(data=i %>% filter(output=="infections"),aes(y=-number),
           position="dodge",stat="identity") +  
  #coord_flip() + 
  facet_grid( ~ risk_measure) +
  scale_fill_manual("Risk category", values = category_cols) +
  #scale_fill_manual(values = c(category_cols_6,category_cols_6), name = "Risk") +
  scale_y_continuous(breaks = c(-25000000,-10000000,0,25000000,50000000,100000000),labels = abs(c(25,10,0,25,50,100)),limits=c(-25000000,100000000)) +
  scale_alpha_discrete(name="Geographic frame",range = c(1,.4)) + 
  theme_minimal() + 
  xlab("Risk category") + 
  ylab("Number (in millions)") +
  geom_hline(yintercept=0, lwd=0.3, colour="grey20") 
  #annotate(x = c(2,4.5,2,2), y = c(20,2,2,25), label=c("Infections","Population","Infections","Population"),    geom="text", angle=90, hjust=0.5, size=3)
  #geom_text(aes(y=number,label=round(number, 1)), vjust=-0.3, color="#6e6666", size=3.5)  
  #facet_share( ~ output, dir = "h", scales = "free", reverse_num = TRUE)


fig3_perc <- ggplot(data=i,aes(x=risk_cat,fill=risk_cat,alpha=denominator)) + 
  geom_bar(data=i %>% filter(output=="population"),aes(y=percent),
           position="dodge",stat="identity") + 
  geom_bar(data=i %>% filter(output=="infections"),aes(y=-percent),
           position="dodge",stat="identity") +  
  #coord_flip() + 
  facet_grid( ~ risk_measure) +
  scale_fill_manual("Risk category", values = category_cols) +
  #scale_fill_manual(values = c(category_cols_6,category_cols_6), name = "Risk") +
  scale_y_continuous(breaks = c(-80,-40,0,40,80),labels = abs(c(80,40,0,40,80)),limits=c(-100,100)) +
  scale_alpha_discrete(name="Geographic frame",range = c(1,.4)) + 
  theme_minimal() + 
  xlab("Risk category") + 
  ylab("Percent (%)") +
  geom_hline(yintercept=0, lwd=0.3, colour="grey20") 


plt <- ggpubr::ggarrange(fig3_num, fig3_perc, labels=c("A", "B"), nrow=2, ncol=1)
#print(plt)
ggsave(filename = paste0(fig_wd, "bar-plot-numbers", code_str, ".pdf"), fig3_num, width = 6, height = 6, units = "in")
ggsave(filename = paste0(fig_wd, "bar-plot-percent", code_str, ".pdf"), fig3_perc, width = 6, height = 6, units = "in")
##"A. Bar plot of the number of people (above x-axis) and number of infections (below x-axis) in the Bangladesh population and in the cholera surveillance zone living in high-moderate-low risk areas as defined by relative seroincidence risk and absolute number of infections risk measures. B. Bar plot of the percentage of the population (above x-axis) and percentage of infections (below x-axis) in Bangladesh and the cholera surveillance zone living in high-moderate-low risk areas using the relative seroincidence risk and absolute number of infections as measures of risk."

######bar plot displayed as population pyramid with bars showing infections and dots showing pop



pyramid_num <- i %>% ggplot(aes(x=risk_cat)) + 
  geom_histogram(data = i %>% filter(output=="infections", risk_measure=="Relative risk"),aes(x=risk_cat,fill=risk_cat,y=number,alpha=denominator),position="dodge",
                 binwidth = 1,stat="identity") + 
  geom_histogram(data = i %>% filter(output=="infections", risk_measure=="Absolute infections"),aes(fill=risk_cat,y=-number,alpha=denominator),position="dodge",
                 binwidth = 1,stat="identity") + 
  geom_point(data = p %>% filter(risk_measure=="Relative risk"),aes(x=risk_cat,y=number,alpha=denominator),position=position_dodge(width = 0.9)) +
  geom_point(data = p %>% filter(risk_measure=="Absolute infections"),aes(x=risk_cat,y=-number,alpha=denominator),position=position_dodge(width = 0.9)) +
  geom_hline(yintercept=0, size=1.5, alpha=0.5) + coord_flip() + 
  scale_y_continuous(breaks = c(-100000000,-75000000,-50000000,-25000000,0,25000000,50000000,75000000,100000000),labels = abs(c(100,75,50,25,0,25,50,75,100)),limits=c(-100000000,100000000)) +
  theme_minimal() + 
  xlab("Risk category") + 
  ylab("Number of infections (in millions)") +
  scale_fill_manual("Risk category", values = category_cols_rev, guide = guide_legend(reverse = TRUE)) +
  scale_alpha_discrete(name="Geographic frame",range = c(1,.4))


pyramid_perc <- i %>% ggplot(aes(x=risk_cat)) + 
  geom_histogram(data = i %>% filter(output=="infections", risk_measure=="Relative risk"),aes(x=risk_cat,fill=risk_cat,y=percent,alpha=denominator),position="dodge",
                 binwidth = 1,stat="identity") + 
  geom_histogram(data = i %>% filter(output=="infections", risk_measure=="Absolute infections"),aes(fill=risk_cat,y=-percent,alpha=denominator),position="dodge",
                 binwidth = 1,stat="identity") + 
  geom_point(data = p %>% filter(risk_measure=="Relative risk"),aes(x=risk_cat,y=percent,alpha=denominator),position=position_dodge(width = 0.9)) +
  geom_point(data = p %>% filter(risk_measure=="Absolute infections"),aes(x=risk_cat,y=-percent,alpha=denominator),position=position_dodge(width = 0.9)) +
  geom_hline(yintercept=0, size=1.5, alpha=0.5) + coord_flip() + 
  scale_y_continuous(breaks = c(-100,-80,-60,-40,-20,0,20,40,60,80,100),labels = abs(c(100,80,60,40,20,0,20,40,60,80,100)),limits=c(-100,100)) +
  theme_minimal() + 
  xlab("Risk category") + 
  ylab("Percent of infections (%)") +
  scale_fill_manual("Risk category", values = category_cols_rev, guide = guide_legend(reverse = TRUE)) +
  scale_alpha_discrete(name="Geographic frame",range = c(1,.4))


plt <- ggpubr::ggarrange(pyramid_num, pyramid_perc, labels=c("A", "B"), nrow=2, ncol=1)
print(plt)
ggsave(filename = paste0(fig_wd, "pyr-plot-numbers", code_str, ".pdf"), pyramid_num, width = 6, height = 6, units = "in")
ggsave(filename = paste0(fig_wd, "pyr-plot-percent", code_str, ".pdf"), pyramid_perc, width = 6, height = 6, units = "in")


```


```{r, fig-bar-plot-cap}

fig_nums(name = "fig-bar-plot-cap", caption = "A. A bar plot of the number of infections in the cholera surveillance zone and the Bangladesh population (shown in different shades as the geographic frame) living in high-moderate-low risk areas as defined by the relative (positive x-axis) and absolute (negative x-axis) risk metrics to define risk thresholds. The dots represent the total population living in high-moderate-low risk areas by each geographic frame, either within the cholera surveillance zone or in all of Bangladesh. B. A bar plot of the percent of infections in the cholera surveillance zone and the Bangladesh population (shown in different shades as the geographic frame) living in high-moderate-low risk areas as defined by the relative (positive x-axis) and absolute (negative x-axis) risk metrics to define risk thresholds. The dots represent the percent of the cholera surveillance zone population and Bangladeshi population living in high-moderate-low risk areas (distinguishable by geographic frame).", display = FALSE)

```

`r fig_nums("fig-bar-plot-cap", display = "full")`



```{r, sfig-sero-buffers-rr, fig.dim = c(12,12)}

## Supplementary Figure 2. A. Surveillance zone with risk categories inside - We overlaid the cholera surveillance zone with the binned relative seroincidence risk maps to examine the distribution of risks in the surveilled areas

sfig2A <- ggplot() + 
  geom_sf(data = adm2_shp, fill = "#808c84", lwd = 0.1) + 
  geom_sf(data = intersect_sero, aes(fill = rr_risk_cat), color = NA, lwd = 0) +
  scale_fill_manual("Risk category", values = category_cols) +
  geom_sf(data = hosp_dat, shape = 3, aes(color = "black"), size = 1) +
  coord_sf(datum = NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel sites",values=c('black'),labels=c('Hospital')) +
  theme_void() 

ggsave(filename = paste0(fig_wd, "sero-buffers-rr-", km_label, code_str, ".pdf"), sfig2A, width = 6.5, height = 4, units = "in")

## Supplementary Figure 2. B. overlaid the cholera surveillance zone with the binned absolute infections map to examine the distribution of risk categories in the surveilled areas

sfig2B <- ggplot() + 
  geom_sf(data = adm2_shp, fill = "#808c84", lwd = 0.1) + 
  geom_sf(data = intersect_sero, aes(fill = inf_risk_cat_toPlt), color = NA, lwd = 0) +
  geom_sf(data = hosp_dat, shape = 3, aes(color = "black"), size = 1) +
  scale_fill_manual("Risk category", values = category_cols) +
  coord_sf(datum = NA) + 
  labs(x="") + labs(y="") + 
  scale_colour_manual(name="Sentinel sites",values=c('black'),labels=c('Hospital')) +
  theme_void() 

ggsave(filename = paste0(fig_wd, "sero-buffers-rr-certainty-", km_label, code_str, ".pdf"), sfig2B, width = 6.5, height = 4, units = "in")


# Plot of relative sero incidence risk outside of cholera surveillance zones

#plt <- ggplot() + 
#  geom_sf(data = adm0_shp, fill = NA, lwd = 0.1, alpha = .1) + 
#  geom_sf(data = sero2, aes(fill = rr_risk_cat), color = NA, lwd = 0) +
#  geom_sf(data = intersect_sero, fill = "white", color = NA, lwd = 0) +
#  geom_sf(data = hosp_dat, shape = 3, color = "black", size = 1, lty = 4) +
#  scale_fill_manual("Relative Risk Category", values = category_cols) +
#  coord_sf(datum = NA) + 
#  labs(x="") + labs(y="") + 
#  theme_void() 

plt<- ggpubr::ggarrange(sfig2A, sfig2B, nrow=1, ncol=2, labels = c("A", "B"))
print(plt)
ggsave(filename = paste0(fig_wd, "supp-figure-2", code_str, ".pdf"), plt, width = 6, height = 6, units = "in")

```


```{r, sfig-sero-buffers-rr-cap}

sfig_nums(name = "sfig-sero-buffers-rr-cap", caption = "A. The relative seroincidence risk within cholera surveillance zones (for subdistrict, district, and tertiary care, and icddr,b hospitals) by risk category. B. The absolute infection risk within cholera surveillance zones (for subdistrict, district, and tertiary care, and icddr,b hospitals) by risk category.", display = FALSE)

```

`r sfig_nums("fig-sero-buffers-rr-cap", display = "full")`


```{r, caption-tab-seropop-rr}

## Supplementary Table 3

## We describe the population living in each risk category 
## caption for table in next chunk
stab_nums(name = "tab-seropop-risk-inf", caption = "**Population living in each risk category.** The population living in high, moderate, and low risk areas according to relative seroincidence risk and absolute risk across Bangladesh. The risk categories are defined by the 25th and 75th percentiles of the relative risk or number of infections in each grid cell.", display = FALSE)

```

`r stab_nums("tab-seropop-risk-inf", display = "full")`

```{r, tab-seropop-rrandinf}
display_rr_riskpops <- sero2 %>%
  group_by(rr_risk_cat) %>%
  summarise(pop1 = sum(pop_toAgg, na.rm = TRUE)) %>% 
  data.frame %>% dplyr::rename(risk_cat=rr_risk_cat) %>%
  dplyr::select(risk_cat, pop1) %>% dplyr::mutate(risk_type="Relative Risk")
  
display_riskpops <- sero2 %>%
  group_by(inf_risk_cat_toPlt) %>%
  summarise(pop1 = sum(pop_toAgg, na.rm = TRUE)) %>% 
  data.frame %>% dplyr::rename(risk_cat=inf_risk_cat_toPlt) %>%
  dplyr::select(risk_cat, pop1) %>% dplyr::mutate(risk_type="Absolute Risk") %>%
  bind_rows(display_rr_riskpops,.)

knitr::kable(display_riskpops, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Risk Level", "Population","Risk Measure"))

```



```{r, tab-greyspots-pop}

## Table 1. A. The percentage of the population not captured in the cholera surveillance zone 

##overlaid the cholera surveillance zone over population data in Bangladesh (original source: 2015 100m WorldPop estimates) to estimate the number of people living outside the cholera surveillance zone 

display_survgreyspot_tab <- map_dfr(mp_names, function(mp_nm){
  
  data.frame(buffer = as.character(sub("km", "", mp_nm)), 
            pop_buffer = sum(sero_buff_mp_ls[[mp_nm]]$pop_toAgg, na.rm = TRUE)) %>%
    dplyr::mutate(greyspot_pop = tot_pop-pop_buffer, prop_insidebuffer = pop_buffer/tot_pop) %>%
    dplyr::mutate(perc_pop = round((1 - prop_insidebuffer)*100,1)) %>%
    dplyr::mutate(greyspot = "Surveillance greyspot") %>%
    dplyr::select(greyspot, greyspot_pop, perc_pop)  %>%
    dplyr::mutate(greyspot_pop=comma_format(digits = 12)(greyspot_pop))
    
})

tab_nums(name = "tab-greyspots", caption = "The population not captured in the surveillance greyspots (cholera surveillance zone).", display = FALSE)

```

`r tab_nums("tab-greyspots", display = "full")`

```{r, tab-greyspots}

knitr::kable(display_survgreyspot_tab, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Greyspot type", "Greyspot population", "Percent in greyspot"))

```


###### Here: Using boots sampling to estimate sentivity table values
- **Should find a way to visualize uncertainty of high risk areas?**
- Should calculate percentage of the population not captured in the cholera surveillance zone (table above) for each sentinel site assignment strategy?

```{r caption-tab-intersect-sero-buffers-rr}

## caption for table in next chunk
tab_nums(name = "intersect-sero-buffers-rr-tab", caption = "**Part 1. Number and percent infections that may be captured in cholera surveillance zones.** The percent infected represents the percentage of infected individuals captured within the cholera surveillance zone out of all infected individuals in Bangladesh. **Part 2. Number and percent infections that may be captured in cholera surveillance zones, categorized by relative risk and absolute risk.** The infections in surveillance zone represents the percentage of infected people in high-moderate-low risk grid cells among all infections within the cholera surveillance zone. The population in surveillance zone represents the percentage of people living in high-moderate-low risk grid cells among all people within the cholera surveillance zone. The distribution should across risk categories should sum to 100% for each set of buffer sizes. **Part 3. Number and percent infections that may be captured in Bangladesh, categorized by relative risk and absolute risk.** The captured at-risk population represents the percentage of high-moderate-low risk populations captured by the cholera surveillance zone out of all high-moderate-low risk populations in Bangladesh. The captured infections represents the percentage of infections in high-moderate-low risk grid cells among all infections in high-moderate-low risk grid cells across Bangladesh.", display = FALSE)

```

`r tab_nums("intersect-sero-buffers-rr-tab", display = "full")`

```{r, tab-intersect-sero-buffers}

## Table 2. Sensitivity measures for both relative seroincidence risk and absolute risk using uncertainty measures calculated off of INLA boot samples

# Set up empty tibbles
tbl1 <- tibble(buff="",rep="",pop_buffer=double(),num_inf=double(),
               perc_inf_buffpop=double(),perc_inf_tot=double())
tbl2 <- tibble(buff="",rep="",risk_type="",risk_cat=factor(),num_inf=double(),
               perc_inf=double(),num_pop=double(),perc_pop=double())
tbl3 <- tibble(buff="",rep="",risk_type="",risk_cat=factor(),pop=double(),num_inf=double(),
               perc_pop=double(),perc_inf=double())

for (i in unique(boots$rep)) {
  
  ### Set up data files/objects to calculate sensitivity for each rep
  sample <- boots %>% filter(rep==i)
  
  ## create risk categories for the map based on 75th and 25th quartiles
  inf_thresh <- round(quantile(sample$implied_inf, probs = c(0.25, 0.75), na.rm = TRUE), 3)
  rr_thresh <- round(quantile(sample$sample_rr, probs = c(0.25, 0.75), na.rm = TRUE), 3)

  sample2 <- sample %>% 
  dplyr::mutate(rr_risk_cat = ifelse(sample_rr < rr_thresh[1], "Low", 
                                     ifelse(sample_rr >= rr_thresh[1] & 
                                              sample_rr < rr_thresh[2], "Moderate", "High")),
                inf_risk_cat = ifelse(implied_inf < inf_thresh[1], "Low", 
                                      ifelse(implied_inf >= inf_thresh[1] & 
                                               implied_inf < inf_thresh[2], "Moderate", "High"))) %>% 
  dplyr::mutate(rr_risk_cat = factor(rr_risk_cat, levels = c("High","Moderate","Low")),
                inf_risk_cat = factor(inf_risk_cat, levels = c("High","Moderate","Low"))) %>%
    st_as_sf() %>% st_transform(., crs = std_crs_txt)
 
  ## overlay sentinel site buffer
  km_vec <- km_vec_ls[[1]] #km_vec <- c(10, 20, 30, 30) - we are only using one set of buffer sizes now

  hosp_dat2 <- hosp_dat %>%  
    dplyr::mutate(buff_radius = ifelse(Type == "subdistrict", km_vec[1], 
                                       ifelse(Type == "district", km_vec[2], 
                                              ifelse(Type == "tertiary", km_vec[3], 
                                                     ifelse(Type == "icddrb", km_vec[4], NA)))))

  buff_sp <- st_buffer(hosp_dat2, dist=hosp_dat2$buff_radius, 
                       nQuadSegs = 30, endCapStyle = "ROUND", joinStyle = "ROUND", mitreLimit = 1) %>%
    dplyr::mutate(hosp_id = hosp_dat2$HOSP,
                  hosp_name = hosp_dat2$Name,
                  hosp_division = hosp_dat2$Division,
                  hosp_type = hosp_dat2$Type)
  
  ## combine buffer polygons per hospital into single multipolygon
  buff_mp <- st_sf(st_union(buff_sp))
  sample_buff_mp <- sf::st_intersection(sample2, buff_mp) 

  ## creating sample df using primary cholera surveillance zone settings  (but vectorize this like above)
  km_label <- "10-20-30-30km"
  sample_buff_df <- sample_buff_mp %>% dplyr::mutate(buff=km_label) %>%
    sf::st_drop_geometry() %>%
    tibble::as_tibble() 
  
  ## other important quantities
  tot_inf <- sum(sample2$implied_inf, na.rm = TRUE)
  tot_pop <- sum(sample2$pop_toAgg, na.rm = TRUE)
  
  ### Calculate table estimates
  
  ## part 1. number and percent of infections that may be captured in cholera surveillance zones
  display_survzone_tab <- sample_buff_df %>% 
    group_by(buff) %>%
    dplyr::summarise(pop_buffer = sum(pop_toAgg, na.rm = TRUE)) %>%
    dplyr::mutate(prop_buffer = pop_buffer/tot_pop)
    
  display_intersect_sero_buffers_tab <- sample_buff_df %>% 
    group_by(buff) %>%
    dplyr::summarise(num_inf = sum(implied_inf, na.rm = TRUE)) %>%
    ungroup %>%
    left_join(display_survzone_tab %>% dplyr::select(buff, pop_buffer)) %>%
    dplyr::mutate(perc_inf_buffpop = round(num_inf/pop_buffer*100, 1), 
                  perc_inf_tot = round(num_inf/tot_inf*100, 1), rep=i) %>% 
    dplyr::select(buff, rep, pop_buffer, num_inf, perc_inf_buffpop, perc_inf_tot) 
  
  ## part 2. number and percent of infections captured in cholera surveillance zones by high-moderate-low categories (percentage of infected people in high-moderate-low risk grid cells among all infections within the cholera surveillance zone)
  tot_inf_rrcat <- sample_buff_df %>% 
    group_by(buff) %>%
    dplyr::summarise(tot_infcat=sum(implied_inf, na.rm = TRUE), tot_popcat=sum(pop_toAgg, na.rm = TRUE)) 

  display_rrcat_in_buffers <- sample_buff_df %>% 
    group_by(buff, rr_risk_cat) %>%
    dplyr::summarise(num_inf = round(sum(implied_inf, na.rm = TRUE)), 
                     num_pop = round(sum(pop_toAgg, na.rm = TRUE))) %>%
    left_join(tot_inf_rrcat, by = c("buff")) %>%
    dplyr::mutate(perc_inf = round(num_inf/tot_infcat*100, 1),
                  perc_pop = round(num_pop/tot_popcat*100, 1), rep=i, 
                  risk_type="Relative Risk",risk_cat=rr_risk_cat) %>% 
    dplyr::select(buff, rep, risk_type, risk_cat, num_inf, perc_inf, num_pop, perc_pop) 
  
  display_cat_in_buffers <- sample_buff_df %>% 
    group_by(buff, inf_risk_cat) %>%
    dplyr::summarise(num_inf = round(sum(implied_inf, na.rm = TRUE)), 
                     num_pop = round(sum(pop_toAgg, na.rm = TRUE))) %>%
    left_join(tot_inf_rrcat, by = c("buff")) %>%
    dplyr::mutate(perc_inf = round(num_inf/tot_infcat*100, 1),
                  perc_pop = round(num_pop/tot_popcat*100, 1), rep=i, 
                  risk_type="Absolute Risk", risk_cat=inf_risk_cat) %>% 
    dplyr::select(buff, rep, risk_type, risk_cat, num_inf, perc_inf, num_pop, perc_pop) %>% bind_rows(display_rrcat_in_buffers,.)
    
  ## part 3. number and percent of infections captured in Bangladesh by risk categories (percentage of high-moderate-low risk populations captured by the cholera surveillance zone out of all high-moderate-low risk populations in Bangladesh)
  rrcat <- sample2 %>% 
    group_by(rr_risk_cat) %>%
    summarise(popcat = sum(pop_toAgg, na.rm = TRUE), infcat = sum(implied_inf, na.rm = TRUE)) %>%
    data.frame %>%
    dplyr::select(rr_risk_cat, popcat, infcat)
  
  infcat <- sample2 %>% 
    group_by(inf_risk_cat) %>%
    summarise(popcat = sum(pop_toAgg, na.rm = TRUE), infcat = sum(implied_inf, na.rm = TRUE)) %>%
    data.frame %>%
    dplyr::select(inf_risk_cat, popcat, infcat)

  display_rrcatIntersect_in_bang <- sample_buff_df %>%
    group_by(buff, rr_risk_cat) %>%
    dplyr::summarise(num_inf = sum(implied_inf, na.rm = TRUE), pop = sum(pop_toAgg, na.rm = TRUE)) %>%
    left_join(rrcat, by = c("rr_risk_cat")) %>%
    dplyr::mutate(perc_pop = round(pop/popcat*100, 1), perc_inf = round(num_inf/infcat*100, 1), rep=i,
                  risk_type="Relative Risk", risk_cat=rr_risk_cat) %>%
    dplyr::select(buff, rep, risk_type, risk_cat, pop, num_inf, perc_pop, perc_inf) 
  
  display_catIntersect_in_bang <- sample_buff_df %>%
    group_by(buff, inf_risk_cat) %>%
    dplyr::summarise(num_inf = sum(implied_inf, na.rm = TRUE), pop = sum(pop_toAgg, na.rm = TRUE)) %>%
    left_join(infcat, by = c("inf_risk_cat")) %>%
    dplyr::mutate(perc_pop = round(pop/popcat*100, 1), perc_inf = round(num_inf/infcat*100, 1), rep=i,
                  risk_type="Absolute Risk", risk_cat=inf_risk_cat) %>%
    dplyr::select(buff, rep, risk_type, risk_cat, pop, num_inf, perc_pop, perc_inf) %>% bind_rows(display_rrcatIntersect_in_bang,.)

  ###  Create tables of sensitivity estimates by rep
  
  tbl1 <- bind_rows(tbl1, display_intersect_sero_buffers_tab) 
  tbl2 <- bind_rows(tbl2, display_cat_in_buffers)
  tbl3 <- bind_rows(tbl3, display_catIntersect_in_bang)
  
}

###Calculate summary statistics

part1 <- tbl1 %>% 
  group_by(buff) %>%
  dplyr::summarise(pop_buffer=mean(pop_buffer),
                   num_inf_mean=mean(num_inf),num_inf_median=median(num_inf),
                   num_inf_lb=quantile(num_inf, c(.025)),num_inf_ub=quantile(num_inf, c(.975)),
                   perc_inf_buffpop_mean=mean(perc_inf_buffpop),perc_inf_buffpop_median=median(perc_inf_buffpop),
                   perc_inf_buffpop_lb=quantile(perc_inf_buffpop,c(0.25)),perc_inf_buffpop_ub=quantile(perc_inf_buffpop,c(0.975)),
                   perc_inf_tot_mean=mean(perc_inf_tot),perc_inf_tot_median=median(perc_inf_tot),
                   perc_inf_tot_lb=quantile(perc_inf_tot,c(0.25)),perc_inf_tot_ub=quantile(perc_inf_tot,c(0.975))) %>%
  ungroup %>%
  dplyr::mutate(buff=km_label,
                num_inf=paste(f_comma(num_inf_mean),"(",f_comma(num_inf_lb),",",f_comma(num_inf_ub),")"),
                perc_inf_buffpop=paste(f_comma(perc_inf_buffpop_mean),"(",f_comma(perc_inf_buffpop_lb),",",f_comma(perc_inf_buffpop_ub),")"),
                perc_inf_tot=paste(f_comma(perc_inf_tot_mean),"(",f_comma(perc_inf_tot_lb),",",f_comma(perc_inf_tot_ub),")")) %>% 
  dplyr::select(buff,pop_buffer,num_inf,perc_inf_buffpop,perc_inf_tot)


part2 <- tbl2 %>%
  group_by(risk_type,risk_cat) %>%
  dplyr::summarise(num_inf_mean=mean(num_inf),num_inf_median=median(num_inf),
                   num_inf_lb=quantile(num_inf, c(.025)),num_inf_ub=quantile(num_inf, c(.975)),
                   perc_inf_mean=mean(perc_inf),perc_inf_median=median(perc_inf),
                   perc_inf_lb=quantile(perc_inf,c(0.25)),perc_inf_ub=quantile(perc_inf,c(0.975)),
                   num_pop_mean=mean(num_pop),num_pop_median=median(num_pop),
                   num_pop_lb=quantile(num_pop, c(.025)),num_pop_ub=quantile(num_pop, c(.975)),
                   perc_pop_mean=mean(perc_pop),perc_pop_median=median(perc_pop),
                   perc_pop_lb=quantile(perc_pop,c(0.25)),perc_pop_ub=quantile(perc_pop,c(0.975))) %>%
  ungroup %>%
  dplyr::mutate(buff=km_label,
                num_inf=paste(f_comma(num_inf_mean),"(",f_comma(num_inf_lb),",",f_comma(num_inf_ub),")"),
                perc_inf=paste(f_comma(perc_inf_mean),"(",f_comma(perc_inf_lb),",",f_comma(perc_inf_ub),")"),
                num_pop=paste(f_comma(num_pop_mean),"(",f_comma(num_pop_lb),",",f_comma(num_pop_ub),")"),
                perc_pop=paste(f_comma(perc_pop_mean),"(",f_comma(perc_pop_lb),",",f_comma(perc_pop_ub),")")) %>% 
  dplyr::select(buff,risk_type,risk_cat,num_inf,perc_inf,num_pop,perc_pop) 
  
  
 part3 <- tbl3 %>%
  group_by(risk_type,risk_cat) %>%
  dplyr::summarise(pop_mean=mean(pop),pop_median=median(pop),
                   pop_lb=quantile(pop, c(.025)),pop_ub=quantile(pop, c(.975)),
                   num_inf_mean=mean(num_inf),num_inf_median=median(num_inf),
                   num_inf_lb=quantile(num_inf, c(.025)),num_inf_ub=quantile(num_inf, c(.975)),
                   perc_pop_mean=mean(perc_pop),perc_pop_median=median(perc_pop),
                   perc_pop_lb=quantile(perc_pop,c(0.25)),perc_pop_ub=quantile(perc_pop,c(0.975)),
                   perc_inf_mean=mean(perc_inf),perc_inf_median=median(perc_inf),
                   perc_inf_lb=quantile(perc_inf,c(0.25)),perc_inf_ub=quantile(perc_inf,c(0.975))) %>%
  ungroup %>%
  dplyr::mutate(buff=km_label,
                pop=paste(f_comma(pop_mean),"(",f_comma(pop_lb),",",f_comma(pop_ub),")"),
                num_inf=paste(f_comma(num_inf_mean),"(",f_comma(num_inf_lb),",",f_comma(num_inf_ub),")"),
                perc_pop=paste(f_comma(perc_pop_mean),"(",f_comma(perc_pop_lb),",",f_comma(perc_pop_ub),")"),
                perc_inf=paste(f_comma(perc_inf_mean),"(",f_comma(perc_inf_lb),",",f_comma(perc_inf_ub),")")) %>% 
  dplyr::select(buff,risk_type,risk_cat,pop,num_inf,perc_pop,perc_inf) 
   
  


### Display tables
knitr::kable(part1, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Buffer size", "Surv. zone pop", "Number infected", "% infected in surv. zone pop", "% of all BGD infections"))


knitr::kable(part2, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Buffer size","Risk Measure","Risk category", "Number infected", "% surv. zone infections", "Surv. zone pop", "% BGD pop in surv. zone"))


knitr::kable(part3, format = "pandoc", booktabs = T, align = "c", row.names = FALSE, col.names = c("Buffer size","Risk Measure","Risk category", "Surv. zone pop", "Surv. zone infections", "Captured At-Risk Pop (%)", "Captured Infections (%)"))

```



