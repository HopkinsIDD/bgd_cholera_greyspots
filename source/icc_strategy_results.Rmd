---
title: "Greyspot sentinel assignment intraclass correlation"
output:
  html_document:
    fig_caption: TRUE
    toc: TRUE
    code_folding: hide
    fig_width: 10
    fig_height: 10
params:
  home_directory: ~/gh/bgd_cholera_greyspots
  niters: 99
  nboots: 100
  testing: FALSE
---
Interrogate outputs from analyze strategy -- 
Variation by rep (bootstrap sample) and sim (sentinel assignment) samples
Variation across strategies

```{r setup, include = FALSE}

knitr::opts_knit$set(root.dir = params$home_directory)
knitr::opts_chunk$set(echo = TRUE, error = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(lme4)
library(sjPlot)
# params <- list(home_directory = "C:/Users/eclee/Dropbox (Bansal Lab)/IDDynamicsJHU/gh/bgd_cholera_greyspots", niters=99, testing=TRUE)
# 

```

```{r readfiles}

niters <- 1:params$niters
nboots <- params$nboots
tmpdirs <- grep("^tmp", list.dirs(path = "generated_data", full.names = FALSE), value=TRUE)
tmpfiles <- paste0("tmpout_", niters, ".csv")
tmpdf <- expand.grid(dir = tmpdirs, file = tmpfiles, stringsAsFactors = FALSE) %>%
  dplyr::mutate(fn = paste0("generated_data/", dir, "/", file))



## get denominators
bootcat <- readr::read_csv("data/boot_cat_denominators.csv", col_types = "cccdd")
## total infections & pop in bangladesh
denominators <- dplyr::filter(bootcat, metric == "inf") %>%
  dplyr::group_by(rep) %>%
  dplyr::summarise(tot_inf = sum(inf_cat_total), tot_pop = sum(pop_cat_total))
tot_pop <- denominators[1,]$tot_pop ## same for all reps
denom_inf <- dplyr::select(denominators, rep, tot_inf)

```

```{r cleandata}
## clean data
orig_grid <- purrr::map_dfr(1:nrow(tmpdf), function(i){
  readr::read_csv(tmpdf[i,]$fn, col_types = cols(metric = col_character())) %>%
    dplyr::mutate(strategy = stringr::str_remove(stringr::str_remove(tmpdf[i,]$dir, "^tmp_"), "_buff10-20-30_seed544400_nsims20"))
})

print("Cleaning data ******")
print(paste("Filter down to", nboots, "bootstrapped samples for comparison"))

cl_grid <- dplyr::filter(orig_grid, !is.na(implied_inf_toAgg)) %>%
  dplyr::filter(rep <= nboots) %>%
  dplyr::mutate(rep = as.character(rep)) 


cl_iter <- dplyr::group_by(cl_grid, strategy, metric, sim, rep) %>%
  dplyr::summarise(pop_survzone = sum(pop_toAgg, na.rm = TRUE),
                  inf_survzone = sum(implied_inf_toAgg, na.rm = TRUE)) 
```

# Variability in total infections in surveillance zone across strategies
## Relative Risk Thresholds

```{r models_rr_across, results = "asis", error = TRUE}

rrdat_ac <- dplyr::filter(cl_iter, metric == "rr") 

rrdat <- dplyr::mutate(rrdat_ac, rep = factor(rep), sim = factor(sim), strategy = factor(strategy))

r1 <- lmer(inf_survzone ~ (1 | rep) , data = rrdat)
r2 <- lmer(inf_survzone ~ (1 | sim), data = rrdat)
r3 <- lmer(inf_survzone ~ (1 | strategy), data = rrdat)
r4 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) , data = rrdat)
r5 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) + (1 | strategy), data = rrdat)

cat(
  tab_model(
  title = paste("relative risk: across strategies"),
  r1,
  r2,
  r3,
  r4,
  r5,
  transform = NULL,
  dv.labels = c(
    "bootsrap (rep)",
    "strategy sample (sim)",
    "strategy",
    "rep, sim",
    "rep, sim, strategy"),
  show.aic = T,
  show.dev = T,
  show.se = T,
  show.ci = T,
  show.df = T,
  collapse.ci = T
  )$knitr, "\n -----\n")

```

## Absolute Risk Thresholds

```{r models_abs_across, results = "asis", error = TRUE}

rrdat_ac <- dplyr::filter(cl_iter, metric == "inf") 

rrdat <- dplyr::mutate(rrdat_ac, rep = factor(rep), sim = factor(sim), strategy = factor(strategy))

r1 <- lmer(inf_survzone ~ (1 | rep) , data = rrdat)
r2 <- lmer(inf_survzone ~ (1 | sim), data = rrdat)
r3 <- lmer(inf_survzone ~ (1 | strategy), data = rrdat)
r4 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) , data = rrdat)
r5 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) + (1 | strategy), data = rrdat)

cat(
  tab_model(
  title = paste("absolute risk: across strategies"),
  r1,
  r2,
  r3,
  r4,
  r5,
  transform = NULL,
  dv.labels = c(
    "bootsrap (rep)",
    "strategy sample (sim)",
    "strategy",
    "rep, sim",
    "rep, sim, strategy"),
  show.aic = T,
  show.dev = T,
  show.se = T,
  show.ci = T,
  show.df = T,
  collapse.ci = T
  )$knitr, "\n -----\n")

```


# Variability in total infections in surveillance zone by strategy
## Relative Risk Thresholds

```{r models_rr, results = "asis", error = TRUE}

unique_strategies <- unique(cl_iter$strategy)
for (i in 1:length(unique_strategies)){

  print(paste("Working on", unique_strategies[i]))
  rrdat <- dplyr::filter(cl_iter, strategy == unique_strategies[i] & metric == "rr") 

  if(params$testing){
    print("Warning: These are testing results!!!")
    rrdat <- dplyr::mutate(rrdat, rep = factor(c(rep(1, 40), rep(2, 59))), sim = factor(c(rep(1, 20), rep(2, 9), rep(3, 70))))
  }

  rrdat <- dplyr::mutate(rrdat, rep = factor(rep), sim = factor(sim))

  r1 <- lmer(inf_survzone ~ (1 | rep) , data = rrdat)
  r2 <- lmer(inf_survzone ~ (1 | sim), data = rrdat)
  r3 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) , data = rrdat)
  
  cat(
    tab_model(
    title = paste("relative risk thresholds:", unique_strategies[i]),
    r1,
    r2,
    r3,
    transform = NULL,
    dv.labels = c(
      "bootsrap (rep)",
      "strategy sample (sim)",
      "rep, sim"),
    show.aic = T,
    show.dev = T,
    show.se = T,
    show.ci = T,
    show.df = T,
    collapse.ci = T
    )$knitr, "\n -----\n")

}


```

## Absolute Risk Thresholds 

```{r models_abs, results = "asis", error = TRUE}

unique_strategies <- unique(cl_iter$strategy)
for (i in 1:length(unique_strategies)){

  print(paste("Working on", unique_strategies[i]))
  rrdat <- dplyr::filter(cl_iter, strategy == unique_strategies[i] & metric == "inf") 

  if(params$testing){
    print("Warning: These are testing results!!!")
    rrdat <- dplyr::mutate(rrdat, rep = factor(c(rep(1, 40), rep(2, 59))), sim = factor(c(rep(1, 20), rep(2, 9), rep(3, 70))))
  }

  rrdat <- dplyr::mutate(rrdat, rep = factor(rep), sim = factor(sim))

  r1 <- lmer(inf_survzone ~ (1 | rep) , data = rrdat)
  r2 <- lmer(inf_survzone ~ (1 | sim), data = rrdat)
  r3 <- lmer(inf_survzone ~ (1 | rep) + (1 | sim) , data = rrdat)
  print(summary(r1))
  print(summary(r2))
  
  cat(
    tab_model(
    title = paste("absolute risk thresholds:", unique_strategies[i]),
    r1,
    r2,
    r3,
    transform = NULL,
    dv.labels = c(
      "bootsrap (rep)",
      "strategy sample (sim)",
      "rep, sim"),
    show.aic = T,
    show.dev = T,
    show.se = T,
    show.ci = T,
    show.df = T,
    collapse.ci = T
    )$knitr, "\n -----\n")

}


```
